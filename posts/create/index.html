<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <script src="/js/users.js" type="module"></script>
        <script src="/js/posts.js" type="module"></script>

        <link rel="stylesheet" href="/css/create.css">
    </head>
    <body>
        <h1 id="mode"></h1>
        <form id="create">
            <input style="height: 26px;font-size:23px;" type="text" placeholder="Some cool title" id="title">
            <p id="text=error"></p>
            <br><br>
            <textarea id="content"></textarea>
            <br><br>
            <input type="submit" value="Done!">
        </form>
        <br><br>
        <div id="preview"></div>

        <script type="module">
            import * as md from "/js/markdown.js"
            import { createPost, updatePost } from "/js/posts.js"

            isSignedIn().then(loggedIn => {
                if(loggedIn == false) location.href = "/"
            })

            const mode = new URL(location.href).searchParams.get("edit") || "create"
            console.log(mode)

            const params = new URL(location.href).searchParams
            var information = {}

            getCurrentUser().then(data => {
                information.currentUser = data.name
            })

            const title = document.getElementById("title")
            const content = document.getElementById("content")

            if(mode == "create") {
                document.getElementById("create").addEventListener("submit", (e) => {
                    if(String(title.value).includes(":") || String(title.value).includes("\"") || String(title.value).includes("'")) {
                        e.preventDefault()
                        alert("Title cannot contain : ' \" ")
                    } else {
                        e.preventDefault()

                        getCurrentUser().then(data => {
                            console.log(data)
                            createPost(
                                title.value,
                                content.value,
                                data.name
                            ).then(() => {
                                location.href = `/posts/?view=${data.name}:${title.value}`
                            })
                        })
                    }
                })
            } else {
                information.postName = params.get("edit").split(":")[1].replace(/%20/gm, ' ')
                console.log(information)

                getCurrentUser().then(user => {
                    loadPostData(user.name, information.postName).then(post => {
                        content.value = post.content
                        title.value = information.postName

                        document.getElementById("preview").innerHTML = md.parse(content.value)
                    })
                })

                document.getElementById("create").addEventListener("submit", (e) => {
                    if(String(title.value).includes(":") || String(title.value).includes("\"") || String(title.value).includes("'")) {
                        e.preventDefault()
                        alert("Title cannot contain : ' \" ")
                    } else {
                        e.preventDefault()

                        getCurrentUser().then(data => {
                            updatePost(
                                information.postName,
                                title.value,
                                content.value,
                                data.name
                            ).then(() => {
                                location.href = `/posts/?view=${data.name}:${title.value}`
                            })
                        })
                    }
                })
            }

            content.addEventListener("input", (e) => {
                document.getElementById("preview").innerHTML = md.parse(content.value)
            })

            title.addEventListener("input", (e) => {
                if(String(title.value).includes(":") || String(title.value).includes("\"") || String(title.value).includes("'")) {
                    e.preventDefault()
                    document.getElementById("text=error").innerHTML = "Titles cannot contain <code>\"</code> <code>'</code> or <code>:</code>"
                } else {
                    document.getElementById("text=error").innerText = ""
                }
            })
        </script>
    </body>
</html>